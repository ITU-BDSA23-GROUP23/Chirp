name: Publish

on:
  release:
    types: [published]
  push:
    branches: [ "release-workflow" ]

jobs:
  release:  
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x
    - name: Build for Linux
      shell: bash
      run: |
        # Define some variables for things we need
        tag=$(git describe --tags --abbrev=0)
        release_name="Chirp-$tag-linux-x64"

        # Build everything
        dotnet publish src/Chirp.CLI/Chirp.CLI.csproj --runtime linux-x64 -c Release -o "$release_name"

        # Pack files
        tar czvf "${release_name}.tar.gz" "$release_name"
          
        # Delete output directory
        rm -r "$release_name"
    - name: Build for Windows
      shell: bash
      run: |
        # Define some variables for things we need
        tag=$(git describe --tags --abbrev=0)
        release_name="Chirp-$tag-win-x64"

        # Build everything
        dotnet publish src/Chirp.CLI/Chirp.CLI.csproj --runtime win-x64 -c Release -o "$release_name"

        # Pack files
        7z a -tzip "${release_name}.zip" "./${release_name}/*"
          
        # Delete output directory
        rm -r "$release_name"
     - name: Build for Mac
       shell: bash
       run: |
         # Define some variables for things we need
         tag=$(git describe --tags --abbrev=0)
         release_name="Chirp-$tag-osx-x64"

         # Build everything
         dotnet publish src/Chirp.CLI/Chirp.CLI.csproj --runtime osx-x64 -c Release -o "$release_name"

         # Pack files
         tar czvf "${release_name}.tar.gz" "$release_name"
          
         # Delete output directory
         rm -r "$release_name"
    - name: test
      run: dotnet test --no-build --verbosity normal
